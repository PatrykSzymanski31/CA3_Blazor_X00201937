@page "/random-whoa"
@using System.Net.Http.Json
@using System.Linq
@using WhoaWebApp
@inject HttpClient Http

<h3>Random Keanu "Whoa"</h3>

@if (isLoading && currentWhoa is null)
{
    <p>Loading your whoa...</p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <p style="color:red">@errorMessage</p> //replace with flavorful error message
}
else if (currentWhoa is null)
{
    <p>No data returned from the API.</p> //replace later!
}
else
{
    <div style="border: 1px solid #ccc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <h4>@currentWhoa.movie (@currentWhoa.year)</h4>

        <p><strong>Character:</strong> @currentWhoa.character</p>
        <p><strong>Director:</strong> @currentWhoa.director</p>
        <p><strong>Timestamp:</strong> @currentWhoa.timestamp / @currentWhoa.movie_duration</p>
        <p><strong>Line:</strong> "@currentWhoa.full_line"</p>
        <p><strong>Whoa # in movie:</strong> @currentWhoa.current_whoa_in_movie of @currentWhoa.total_whoas_in_movie</p>

        @if (!string.IsNullOrWhiteSpace(currentWhoa.poster))
        {
            <img src="@currentWhoa.poster"
                 alt="Movie poster"
                 style="max-width: 200px; display:block; margin-top:0.5rem;" />
        }

        @if (!string.IsNullOrWhiteSpace(videoUrl))
        {
            <video @key="videoUrl" controls style="max-width: 100%; margin-top:0.5rem;">
                <source src="@videoUrl" type="video/mp4" />
                Your browser does not support the video tag.
            </video>
        }

        @if (!string.IsNullOrWhiteSpace(currentWhoa.audio))
        {
            <audio @key="videoUrl" controls style="width: 100%; margin-top:0.5rem;">
                <source src="@currentWhoa.audio" type="audio/mpeg" />
                Your browser does not support the audio element.
            </audio>
        }
    </div>
}

<button @onclick="LoadRandomWhoa" disabled="@isLoading">
    @(isLoading ? "Loading..." : "Get another whoa")
</button>

@code {
    private WhoaResult? currentWhoa;
    private bool isLoading = true;
    private string? errorMessage;
    private string? videoUrl;

    protected override async Task OnInitializedAsync()
    {
        await LoadRandomWhoa();
    }

    private async Task LoadRandomWhoa()
    {
        isLoading = true;
        errorMessage = null;

        videoUrl = null;
        currentWhoa = null;

        try
        {
            var url = "https://whoa.onrender.com/whoas/random";

            var list = await Http.GetFromJsonAsync<List<WhoaResult>>(url);

            currentWhoa = list?.FirstOrDefault();

            // Pick a 720p resolution if available
            if (currentWhoa?.video != null && currentWhoa.video.Count > 0)
            {
                if (currentWhoa.video.TryGetValue("720p", out var v720))
                    videoUrl = v720;
                else if (currentWhoa.video.TryGetValue("480p", out var v480))
                    videoUrl = v480;
                else
                    videoUrl = currentWhoa.video.Values.FirstOrDefault();
            }
            else
            {
                videoUrl = null;
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }
}
