@page "/whoa-search"
@using System.Net.Http.Json
@using WhoaWebApp
@inject HttpClient Http

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />

<h3>Search Whoas by Movie</h3>

<div class="mb-3">
    <label for="resultsInput">Number of results</label>
    <input id="resultsInput"
           type="number"
           class="form-control"
           min="1"
           max="30"
           @bind="resultsCount" />
    <small class="text-muted">Between 1 and 30 results.</small>
</div>

<div class="mb-3">
    <label for="movieSelect">Movie</label>
    <select id="movieSelect"
            class="form-select"
            @bind="selectedMovie">
        @foreach (var m in availableMovies)
        {
            <option value="@m">@m</option>
        }
    </select>
</div>

<button class="btn btn-primary" @onclick="SearchAsync">
    Search
</button>

<hr />

@if (isLoading)
{
    <p>Loading results...</p>
}
else if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <p class="text-danger">@errorMessage</p>
}
else if (searchResults is { Count: > 0 })
{
    <ul class="list-group">
        @foreach (var whoa in searchResults)
        {
            <li class="list-group-item">
                <strong>@whoa.movie</strong> (@whoa.year)<br />
                <em>@whoa.character</em><br />
                "@whoa.full_line"

                @* AUDIO CLIP *@
                @if (!string.IsNullOrWhiteSpace(whoa.audio))
                {
                    <audio controls style="width: 100%; margin-top:0.5rem;">
                        <source src="@whoa.audio" type="audio/mpeg" />
                        Your browser does not support the audio element.
                    </audio>
                }
                
            </li>
        }
    </ul>

    <hr />

    <h4>Movie details with OMDb</h4>

    @if (isMovieLoading && searchResults != null)
    {
        <p>Loading movie details...</p>
    }
    else if (!string.IsNullOrEmpty(movieError))
    {
        <p class="text-danger">@movieError</p>
    }
    else if (currentMovie != null)
    {
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        @if (!string.IsNullOrWhiteSpace(currentMovie.Poster) &&
                                        currentMovie.Poster != "N/A")
                        {
                            <img src="@currentMovie.Poster"
                                 alt="Poster for @currentMovie.Title"
                                 style="max-width:100%; border-radius:4px;" />
                        }
                    </div>
                    <div class="col-md-9">
                        <p><strong>Title:</strong> @currentMovie.Title (@currentMovie.Year)</p>
                        <p><strong>Genre:</strong> @currentMovie.Genre</p>
                        <p><strong>Director:</strong> @currentMovie.Director</p>
                        <p><strong>Actors:</strong> @currentMovie.Actors</p>
                        <p><strong>IMDb rating:</strong> @currentMovie.imdbRating</p>
                        <p><strong>Plot:</strong> @currentMovie.Plot</p>

                        @if (!string.IsNullOrWhiteSpace(currentMovie.imdbID))
                        {
                            <a href="https://www.imdb.com/title/@currentMovie.imdbID"
                               target="_blank">
                                View on IMDB
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <p>Select a movie and run a search to see its details here.</p>
    }

}
else if (searchResults is not null)
{
    <p>We've ran into an error and found nothing.</p>
}

@code {

    private OmdbMovie? currentMovie;      
    private bool isMovieLoading;          
    private string? movieError;          
    private const string OmdbApiKey = "46c14fa0";

    private List<WhoaResult>? searchResults;
    private bool isLoading;
    private string? errorMessage;

    private int resultsCount = 5;
    private List<string> availableMovies = new();
    private string? selectedMovie;
    private bool isMoviesLoading = true;
    private string? moviesError;

    protected override async Task OnInitializedAsync()
    {
        await LoadMoviesAsync();
    }

    private async Task LoadMoviesAsync()
    {
        isMoviesLoading = true;
        moviesError = null;

        try
        {
            var url = "https://whoa.onrender.com/whoas/movies";
            var movies = await Http.GetFromJsonAsync<List<string>>(url);

            if (movies is { Count: > 0 })
            {
                availableMovies = movies.OrderBy(m => m).ToList();
                selectedMovie = availableMovies.FirstOrDefault();
            }
            else
            {
                moviesError = "No movies were returned by the API.";
            }
        }
        catch (Exception ex)
        {
            moviesError = $"Failed to load movies: {ex.Message}";
        }
        finally
        {
            isMoviesLoading = false;
        }
    }

    private async Task SearchAsync()
    {
        errorMessage = null;

        if (string.IsNullOrWhiteSpace(selectedMovie))
        {
            errorMessage = "Please select a movie.";
            return;
        }

        if (resultsCount < 1 || resultsCount > 30)
        {
            errorMessage = "Please choose a number of results between 1 and 30.";
            return;
        }

        isLoading = true;
        isMovieLoading = true;
        movieError = null;
        currentMovie = null;

        try
        {
            var encodedMovie = Uri.EscapeDataString(selectedMovie);
            var url =
                $"https://whoa.onrender.com/whoas/random?results={resultsCount}&movie={encodedMovie}";

            
            searchResults = await Http.GetFromJsonAsync<List<WhoaResult>>(url);

      
            await LoadMovieDetailsForSelectedMovie();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error searching whoas: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
    private async Task LoadMovieDetailsForSelectedMovie()
    {
        if (string.IsNullOrWhiteSpace(selectedMovie))
        {
            movieError = "No movie selected.";
            isMovieLoading = false;
            return;
        }

        try
        {
            var encodedTitle = Uri.EscapeDataString(selectedMovie);
            var url = $"https://www.omdbapi.com/?apikey={OmdbApiKey}&t={encodedTitle}";

            var result = await Http.GetFromJsonAsync<OmdbMovie>(url);

            if (result == null ||
                string.Equals(result.Response, "False", StringComparison.OrdinalIgnoreCase))
            {
                movieError = result?.Error ?? "No additional movie info found.";
            }
            else
            {
                currentMovie = result;
            }
        }
        catch (Exception ex)
        {
            movieError = $"Error loading movie details: {ex.Message}";
        }
        finally
        {
            isMovieLoading = false;
        }
    }


}
